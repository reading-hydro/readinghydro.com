<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@2.0.1/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0/dist/chartjs-adapter-luxon.min.js"></script>
<!-- For luxon formatting see https://github.com/moment/luxon/blob/master/docs/formatting.md -->
<script src="https://unpkg.com/js-datepicker@5.18.1/dist/datepicker.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/js-datepicker@5.18.1/dist/datepicker.min.css">

 
<style>

    .tt {
         font-family: Arial, Helvetica, sans-serif;
         font-size: 20px;
         text-align: center;
         margin-bottom: 30px;
                    }
     .sub1 {
         font-family: Arial, Helvetica, sans-serif;
         font-size: 18px;
         text-align: center;
         padding-right: 60px;
         margin-bottom: 20px;
     }
     .sub2 {
         font-family: Arial, Helvetica, sans-serif;
         font-size: 18px;
         text-align: center;
         padding-bottom: 20px;
     }
     .wra {
        max-width: 1280px;
        margin: auto;
     }

     .col_lef {
        max-width: 500px;
        padding-bottom: 40px;
        float: left;
     }
     .col_rig {
        max-width: 780px;
        padding-bottom: 40px;
        float: left;
     }
     .btn {
         font-size: 18px;
         font-family: Arial, Helvetica, sans-serif;
         padding: 10px 16px;
         margin: 5px;
         border-radius: 4px;
         background-color: #d3d3d3;
     }
     .lab {
         font-family: Arial, Helvetica, sans-serif;
         font-style: normal;
         white-space: nowrap;
     }

     /* Style the active class, and buttons on mouse-over */
     .active, .btn:hover {
     background-color: #1a73e8;
     color: white;
     }
     .box {
         width: 420px;
         height: 70px;
         margin: 5px 0;
         padding: 5px 20px 5px 10px;
         font-family: Arial, Helvetica, sans-serif;
         font-size: 22px;
         color: white;
         float: left;
     }
     .inner {
         height: 70px; 
         margin-top: -20px;
         text-align: right;
         display:flex;                
         align-items: center;
         justify-content: flex-end;
         font-weight: bold;
         color: white;               
     }
     .fontbig {
         font-size: 38px;            
     }
     .fontsmall {
         font-size: 25px;            
     }
     .cwra {
         width: 780px;
         height: 390px;
         margin: auto;
     }
     .cle {
         clear: left;
     }
     #ts {
         white-space: nowrap;
     }
    #con {
        max-width: 1280px;
         margin: auto;
         /* override WP theme */
        line-height: 1.0;
    }
     #pan {
         max-width: 760px;
         border: lightgrey solid 2px;
         background-color: #e7e7e7;
         padding-top: 10px;
         margin: 5px auto;
     }
     #dpk1, #dpk2 {
         margin: 10px;
         font-family: Arial, Helvetica, sans-serif;
         /* override WP theme */
         background: white;
         border: 1px solid black;
     }
     #btw {
         max-width: 780px;
         margin: auto;
         text-align:center;
     }
     #dtw {
         max-width: 780px;
         margin: auto;
         text-align:center;
     }
     #tem {
        background-color: #ff6d56;
     }
    #hum {
        background-color: #57b7dd;
     }
    #lig {
        background-color: #ffbe0a;
     }
    #mot {
        background-color: #8ac539;
     }
    #smo {
        background-color: #a98cbc;
     }
    #doo {
        background-color: #fa9233;
     }
    #ga1 {
        background-color: #e053de;
     }
    #ga2 {
        background-color: #e053de;
     }

     #ca_tem {
         height: 100%;                          
     }
     #ca_hum {
         height: 100%;                          
     }
     #ca_lig {
         height: 100%;                          
     }
     #ca_mot {
         height: 100%;                          
     }
     #ca_ga1 {
        height: 100%;
     }
     #ca_ga2 {
        height: 100%;
     }

     @media only screen and (max-width: 1420px) {
         .wra {
         max-width: 580px;                
         }
         .col_lef {
         max-width: 580px;
         float: none;                
         }
         .sub1 {
         padding-right: 0;
          }
         .box {
         float: none;
         margin: 5px auto;
        }
         .col_rig {
         max-width: 580px;                
         }
         .cwra {
         width: 580px;
         height: 290px; 
         margin: auto;        
        }
     }
     @media only screen and (max-width: 610px) {
         .wra {
         max-width: 350px;
          }
          #btw {
         max-width: 300px;
          }
          #dtw {
         width: 300px;
          }                 
          .col_lef {
         max-width: 350px;
         float: none;  
          }
          .sub1, .sub2 {
         padding-right: 0;
         font-size: 17px;
         margin-bottom: 10px;
          }
          .box {
         width: 320px;
         float: none;  
         margin: 5px auto;
        }
        .fontbig {
            font-size: 30px;
        }
        .fontsmall {
            font-size: 20px;
        }
          .col_rig {
         max-width: 350px;
          }
          .cwra {
              width: 350px;
              height: 290px;
              margin: auto;
          }
          
     }
     @media only screen and (max-width: 360px) {
         /* this is for really tiny phones */
        .box {
         width: 270px;
         float: none;  
         margin: 5px auto;
        }
     }
     
 
</style>

<script type="text/javascript">
//<!--
// DO NOT REMOVE the comment above, it stops Wordpress from escaping ampersands
        
        // set default API query date to last day
        var today_q = new Date()
		var today_y = new Date()						
        today_q.setDate(today_q.getDate())
        today_y.setDate(today_q.getDate() -1) //yesterday is to request extra day for gap in BST																								

        var ds1 = luxon.DateTime.fromJSDate(today_y).toFormat('yyyyLLdd')
        var ds2 = luxon.DateTime.fromJSDate(today_q).toFormat('yyyyLLdd')
        
        //check for query string and set new dates
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        if (urlParams.has('var1')) {
                //request an extra day of data to avoid gap at beginning of time period for BST
                var myBST1 = urlParams.get('var1')
                var myBST1_date = luxon.DateTime.fromFormat(myBST1, 'yyyyLLdd').startOf('day').toJSDate()//testing
                let myBSTvar1 = new Date(myBST1_date)
                myBSTvar1.setDate(myBSTvar1.getDate() - 1)
                var myds1 = luxon.DateTime.fromJSDate(myBSTvar1).toFormat('yyyyLLdd')																							   
                var myds1 = urlParams.get('var1')
                var myds2 = urlParams.get('var2')
                var myhighlight = urlParams.get('var3')
        
                var myurl = 'https://readinghydro.org/api/ttn/between/' + myds1 + '/' + myds2
                var myurl_gate = 'https://readinghydro.org/api/sluice/between/' + myds1 + '/' + myds2   
                var param1 = myBST1// set param1 to the actual requested date
								 
                var param2 = myds2
                var param3 = myhighlight
        } else {
                var myurl = 'https://readinghydro.org/api/ttn/between/' + ds1 + '/' + ds2
                var myurl_gate = 'https://readinghydro.org/api/sluice/between/' + ds1 + '/' + ds2
                var param1 = ds1
                var param2 = ds2
                var param3 = 0
        }
        
        GoDoIt(myurl, myurl_gate, param1, param2, param3)
        
        async function GoDoIt (){
        var myreturn = await getData(myurl, param1, param2, param3);
        var myreturn_gate = await getData_gate();
        var global_data_0 = myreturn[0]
        var global_data = global_data_0.filter(function(item){
                        return item.device_id == 'rdghydro-ers001'
                    })
        var smoke_data = global_data_0.filter(function(item){
                        return item.device_id == 'dilu-smoke-002'
                    })
        var door_data = global_data_0.filter(function(item){
                        return item.device_id == 'dilu-door-005'
                    })
        var gate_data_0 = myreturn_gate[0]
        var gate1_data = gate_data_0.filter(function(item){
                        return item.sensor == 'sluice_1'
                    })
        var gate2_data = gate_data_0.filter(function(item){
                        return item.sensor == 'sluice_2'
                    })
        var param1 = myreturn[1]
        var param2 = myreturn[2]
        var param3 = myreturn[3]

        var myChart_temp
        var myChart_humid
        var myChart_light
        var myChart_motion
        var myChart_gate1
        var myChart_gate2

        const container = document.createElement('div')
        const title = document.createElement('h1')
        const subtitle1 = document.createElement('div')
        const subtitle2 = document.createElement('div')
        const col_wrapper = document.createElement('div')
        const col_left = document.createElement('div')
        const col_right = document.createElement('div')
        const panel = document.createElement('div')
        const buttonwrap = document.createElement('div')
        const button1 = document.createElement('button')
        const button2 = document.createElement('button')
        const button3 = document.createElement('button')
        const button4 = document.createElement('button')
        const datewrap = document.createElement('div')
        const datepick1 = document.createElement('input')
        const datepick2 = document.createElement('input')
        const label1 = document.createElement('label')
        const label2 = document.createElement('label')
        const nowtemp = document.createElement('div')
        const nowhumid = document.createElement('div')
        const nowlight = document.createElement('div')
        const nowmotion = document.createElement('div')
        const nowsmoke = document.createElement('div')
        const nowdoor = document.createElement('div')
        const nowgate1 = document.createElement('div')
        const nowgate2 = document.createElement('div')
        const inner_nowtemp = document.createElement('div')
        const inner_nowhumid = document.createElement('div')
        const inner_nowlight = document.createElement('div')
        const inner_nowmotion = document.createElement('div')
        const inner_nowsmoke = document.createElement('div')
        const inner_nowdoor = document.createElement('div')
        const inner_nowgate1 = document.createElement('div')
        const inner_nowgate2 = document.createElement('div')
        const canvwrap_temp = document.createElement('div')
        const canvwrap_humid = document.createElement('div')
        const canvwrap_light = document.createElement('div')
        const canvwrap_motion = document.createElement('div')
        const canvwrap_gate1 = document.createElement('div')
        const canvwrap_gate2 = document.createElement('div')
        const clear = document.createElement('p')
        const canv_temp = document.createElement('canvas')
        const canv_humid = document.createElement('canvas')
        const canv_light = document.createElement('canvas')
        const canv_motion = document.createElement('canvas')
        const canv_gate1 = document.createElement('canvas')
        const canv_gate2 = document.createElement('canvas')
        
        container.id = "con"							 
        panel.id = "pan"
        buttonwrap.id = "btw"
        datewrap.id = "dtw"
        datepick1.type = "text"
        datepick1.id = "dpk1"
        datepick2.type = "text"
        datepick2.id = "dpk2"
        label1.for = "dpk1"
        label2.for = "dpk2"
        nowtemp.id = "tem"
        nowhumid.id = "hum"
        nowlight.id = "lig"
        nowmotion.id = "mot"
        nowsmoke.id = "smo"
        nowdoor.id = "doo"
        nowgate1.id = "ga1"
        nowgate2.id = "ga2"
        canv_temp.id = "ca_tem"
        canv_humid.id = "ca_hum"
        canv_light.id = "ca_lig"
        canv_motion.id = "ca_mot"
        canv_gate1.id = "ca_ga1"
        canv_gate2.id = "ca_ga2"

        title.className = "tt"
        subtitle1.className = "sub1"
        subtitle2.className = "sub2"
        col_wrapper.className = "wra"
        col_left.className = "col_lef"
        col_right.className = "col_rig"
        nowtemp.className = "box"
        nowhumid.className = "box"
        nowlight.className = "box"
        nowmotion.className = "box"
        nowsmoke.className = "box"
        nowdoor.className = "box"
        nowgate1.className = "box"
        nowgate2.className = "box"
        inner_nowtemp.className = "inner fontbig"
        inner_nowhumid.className = "inner fontbig"
        inner_nowlight.className = "inner fontbig"
        inner_nowmotion.className = "inner fontbig"
        inner_nowsmoke.className = "inner fontsmall"
        inner_nowdoor.className = "inner fontsmall"
        inner_nowgate1.className = "inner fontbig"
        inner_nowgate2.className = "inner fontbig"
        clear.className = "cle"
        button1.className = "btn active"
        button2.className = "btn"
        button3.className = "btn"
        button4.className = "btn"
        if (param3 == 1) {
            button1.className = "btn"
            button2.className = "btn active"
            button3.className = "btn"
            button4.className = "btn"
        }
        if (param3 == 2) {
            button1.className = "btn"
            button2.className = "btn"
            button3.className = "btn active"
            button4.className = "btn"
        }
        if (param3 == 3) {
            button1.className = "btn"
            button2.className = "btn"
            button3.className = "btn"
            button4.className = "btn active"
        }
        if (param3 == 4) {
            button1.className = "btn"
            button2.className = "btn"
            button3.className = "btn"
            button4.className = "btn"
        } 
        label1.className = "lab"
        label2.className = "lab"
        canvwrap_temp.className = "cwra"
        canvwrap_humid.className = "cwra"
        canvwrap_light.className = "cwra"
        canvwrap_motion.className = "cwra"
        canvwrap_gate1.className = "cwra"
        canvwrap_gate2.className = "cwra"

        title.innerHTML = "Turbine House"
        subtitle1.innerHTML = `Current conditions: <span id="ts">${luxon.DateTime.fromISO(global_data[0].received_at).toFormat('ff')} </span>`
        subtitle2.innerHTML = "<span>Conditions over selected period</span>"
        button1.innerHTML = "Last day"
        button1.onclick = function(){picker2.setDate(today_end, true); picker1.setDate(today, true); selectTimescale(today, today_end, param1, param2, param3)}
        button2.innerHTML = "Last week"
        button2.onclick = function(){picker2.setDate(today_end, true); picker1.setDate(lastweek, true); param3 = 1; selectTimescale(lastweek, today_end, param1, param2, param3)}
        button3.innerHTML = "Last month"
        button3.onclick = function(){picker2.setDate(today_end, true); picker1.setDate(lastmonth, true); param3 = 2; selectTimescale(lastmonth, today_end, param1, param2, param3)}
        button4.innerHTML = "Last year"
        button4.onclick = function(){picker2.setDate(today_end, true); picker1.setDate(lastyear, true); param3 = 3; selectTimescale(lastyear, today_end, param1, param2, param3)}

        nowtemp.innerHTML = "Temperature (&deg;C)"
        nowhumid.innerHTML = "Humidity (&percnt;)"
        nowlight.innerHTML = "Light (Lux)" 
        nowmotion.innerHTML = "Motion counts"
        nowsmoke.innerHTML = "Smoke alarm status"
        nowdoor.innerHTML = "Door status"
        nowgate1.innerHTML = "Sluice gate 1 raised (mm)"
        nowgate2.innerHTML = "Sluice gate 2 raised (mm)"
        label1.innerHTML = "Start date"
        label2.innerHTML = "End date"
        inner_nowtemp.textContent = global_data[0].temperature
        inner_nowhumid.textContent = global_data[0].humidity
        inner_nowlight.textContent = global_data[0].light
        inner_nowmotion.textContent = global_data[0].motion 
		smoketext = 'Undefined'
        if (typeof smoke_data[0] !== 'undefined'){ 
        smoketext = smoke_data[0].smokeStatus
        } 
        inner_nowsmoke.textContent = smoketext.replace(/surrounding/i, "") 
        if (typeof door_data[0] !== 'undefined'){
        inner_nowdoor.textContent = door_data[0].doorStatus 
        }
        inner_nowgate1.textContent = gate1_data[0].gate_raised_mm
        inner_nowgate2.textContent = gate2_data[0].gate_raised_mm
        nowtemp.append(inner_nowtemp)
        nowhumid.append(inner_nowhumid)
        nowlight.append(inner_nowlight)
        nowmotion.append(inner_nowmotion)
        nowsmoke.append(inner_nowsmoke)
        nowdoor.append(inner_nowdoor)
        nowgate1.append(inner_nowgate1)
        nowgate2.append(inner_nowgate2)

        col_left.append(subtitle1)
        col_left.append(nowtemp, nowhumid, nowlight, nowmotion, nowsmoke, nowdoor, nowgate1, nowgate2, clear)
        
        col_right.append(subtitle2)
        buttonwrap.append(button1, button2, button3, button4, clear)
        datewrap.append(label1, datepick1, label2, datepick2, clear)
        panel.append(buttonwrap, datewrap)
        col_right.append(panel)
        canvwrap_temp.append(canv_temp)
        canvwrap_humid.append(canv_humid)  
        canvwrap_light.append(canv_light)
        canvwrap_motion.append(canv_motion)
        canvwrap_gate1.append(canv_gate1)
        canvwrap_gate2.append(canv_gate2)
        col_right.append(canvwrap_temp, canvwrap_humid, canvwrap_light, canvwrap_motion, canvwrap_gate1, canvwrap_gate2)
        //col_right.append(canvwrap_temp, canvwrap_humid, canvwrap_light, canvwrap_motion, canvwrap_gate2)

        //col_wrapper.append(title) //Hide title for Wordpress
        col_wrapper.append(col_left, col_right)
        container.append(col_wrapper)
        
        //local
        //document.body.append(container)
        //Wordpress
        var target = document.getElementsByClassName("entry-content");
        target[0].append(container)
    
    //filter by date
    let today = new Date()
    let today_end = new Date()
							  
    let lastweek = new Date()
    let lastmonth = new Date()
    let lastyear = new Date()
    today.setDate(today.getDate())
    today_end.setDate(today.getDate())
    lastweek.setDate(today.getDate() - 7)
    lastmonth.setDate(today.getDate() - 31)
    lastyear.setDate(today.getDate() - 365)
    
    today = luxon.DateTime.fromJSDate(today).startOf('day').toJSDate()
    today_end = luxon.DateTime.fromJSDate(today).endOf('day').toJSDate()
    lastweek = luxon.DateTime.fromJSDate(lastweek).startOf('day').toJSDate()
    lastmonth = luxon.DateTime.fromJSDate(lastmonth).startOf('day').toJSDate()
    lastyear = luxon.DateTime.fromJSDate(lastyear).startOf('day').toJSDate()

    // convert params to dates
    var param1_date = luxon.DateTime.fromFormat(param1, 'yyyyLLdd').startOf('day').toJSDate()
    var param2_date = luxon.DateTime.fromFormat(param2, 'yyyyLLdd').endOf('day').toJSDate()

    var picked = false
    // datepicker
    const picker1 = datepicker('#dpk1', { id: 1, dateSelected: param1_date, onSelect: instance => {picked = true; selectTimescale(picker1.getRange().start, dayEnd(picker1.getRange().end), param1, param2, param3 ) }})
    const picker2 = datepicker('#dpk2', { id: 1, dateSelected: param2_date, onSelect: instance => {picked = true; selectTimescale(picker2.getRange().start, dayEnd(picker2.getRange().end), param1, param2, param3 ) }})

    // push end date to end of day
    function dayEnd(pick){
        var dayend = luxon.DateTime.fromJSDate(pick).endOf('day').toJSDate()
        return dayend
    }

// if reloaded with last week, month or year buttons
if (param2_date.getDate() == today.getDate()) {
   picker2.setDate(today_end, true)
}

//default timescale for first page load = last day
if (!urlParams.has('var1')) {
    selectTimescale(today, today_end, param1, param2, param3)
    picker2.setDate(today_end, true)
} else {
    selectTimescale(param1_date, param2_date, param1, param2, param3)   
}

//else select timescale using parameters from buttons or datepicker
function selectTimescale(mystart, myend, myparam1, myparam2, myparam3) {

//reload page and fetch more data if needed
        if (myparam1) {
            var myparam1_date = luxon.DateTime.fromFormat(myparam1, 'yyyyLLdd').startOf('day').toJSDate()
            } else {
                myparam1_date = today
            }

    if (mystart < myparam1_date) {
        
            if (picked == true) {
                myparam3 = 4
            } 

            var newstart = luxon.DateTime.fromJSDate(mystart).toFormat('yyyyLLdd')
            var newend = luxon.DateTime.fromJSDate(myend).toFormat('yyyyLLdd')
            var path = window.location.href.split('?')[0]
            location.href = path + '?var1=' + newstart + '&var2=' + newend + '&var3=' + myparam3
            return
        } 

    var selection = global_data.filter(function(item){
                return new Date(item.received_at) >= mystart
            })
            var mystarttime = mystart
            var myendtime = myend
            var mylength = myendtime - mystarttime
            if (mylength >= 172800000){
                myunit = 'day'
            }else{
                myunit = 'hour'
            }

            // Downsample if greater than 10512 data points (approx 2.5 months)
            // No of points will vary between 5256 and 10512
            if (selection.length > 10512){
                var step = Math.ceil(selection.length/10512)
                var reduced = []
                for (i = 0; i < selection.length; i++) {
                    if(i % step === 0){
                        reduced.push(selection[i])
                    }
                }
                selection = reduced
                }

            const xs = []
            const xs5 = []
            const xs6 = []
            const ys1 = []
            const ys2 = []
            const ys3 = []
            const ys4 = []
            const ys5 = []
            const ys6 = []
            for(item of selection) {                

                //convert the timestamp to milliseconds (faster)                
                const mydate1 = new Date(item.received_at)
                const mydate = mydate1.getTime()
                xs.push(mydate);
                const mytemp = item.temperature;
                ys1.push(mytemp);
                const myhum = item.humidity;
                ys2.push(myhum);
                const mylig = item.light;
                ys3.push(mylig);
                const mymot = item.motion;
                ys4.push(mymot);
            }

            //add sluice data
            if (typeof gate1_data !== 'undefined'){
            for(item of gate1_data){
                //convert the timestamp to milliseconds (faster)                
                const mygate1date1 = new Date(item.date)
                const mygate1date = mygate1date1.getTime()
                xs5.push(mygate1date);
                const mygate1status = item.gate_raised_mm.toFixed(2)
                ys5.push(mygate1status)
                }
            }

            if (typeof gate2_data !== 'undefined'){
            for(item of gate2_data){
                //convert the timestamp to milliseconds (faster)                
                const mygate2date1 = new Date(item.date)
                const mygate2date = mygate2date1.getTime()
                xs6.push(mygate2date);
                const mygate2status = item.gate_raised_mm.toFixed(2)
                ys6.push(mygate2status)
            }
            }

            // Add active class to the current button on click
            var btns = document.getElementsByClassName("btn");
            for (var i = 0; i < btns.length; i++) {
            btns[i].addEventListener("click", function() {
                var current = document.getElementsByClassName("active");
                if (typeof current[0] !== 'undefined'){
                current[0].className = current[0].className.replace(" active", "");
                }
                this.className += " active";
                });
                }
             if (picked == true) {
                for (var i = 0; i < btns.length; i++) {
                    btns[i].classList.remove("active")
                } 
                picked = false
            }

        //Set global defaults for charts
        //More settings can be global if we use Chartjs v3
        Chart.defaults.global.tooltips.callbacks.title = function(t, d) {
                                return luxon.DateTime.fromMillis(d.labels[t[0].index]).toFormat('ff');
                                        }
        //Chart.defaults.global.animation.duration = 0
        Chart.defaults.global.maintainAspectRatio = false
        Chart.defaults.global.title.display = true
        Chart.defaults.global.title.fontSize = 20
        Chart.defaults.global.title.fontStyle = 'bold'
        Chart.defaults.global.legend.display = false


        //Graph 1 - temperature            
        if (myChart_temp) {
            myChart_temp.destroy();
            }

        var ctx_tem = document.getElementById('ca_tem').getContext('2d');
        myChart_temp = new Chart(ctx_tem, {
                type: 'line',
                data: {
                    labels: xs,
                    datasets: [
                        {                                
                        data: ys1,
                        fill: true,
                        backgroundColor: 'rgb(255, 109, 86, 0.7)',
                        borderColor: 'rgb(255, 109, 86, 0.7)',
                        borderWidth: 1,
                        radius: 0
                        },                        
                    ]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                type: 'time',
                                time: {
                                    minUnit: myunit,
                                }, 
                                distribution: 'linear',
                                ticks: {
                                    fontStyle: "bold",
                                    min: mystarttime,
                                    max: myendtime,
                                        },
                                scaleLabel: {
                                    display: false,                                                                  
                                        }
                                    }
                            ],
                            yAxes: [{
                                ticks: {
                                    fontSize: 15,
                                    fontStyle: "bold",
                                        },
                                        scaleLabel: {
                                    display: false                                      
                                        }
                                    }]
                            },
                        title: {
                            text: "Temperature (°C)"
                                },
                            } 
            });
        // End of graph 1

        //Graph 2 - humidity
        if (myChart_humid) {
            myChart_humid.destroy();
            }

        var ctx_hum = document.getElementById('ca_hum').getContext('2d');
        myChart_humid = new Chart(ctx_hum, {
                type: 'line',
                data: {
                    labels: xs,
                    datasets: [
                        {
                        
                        data: ys2,
                        fill: true,
                        backgroundColor: 'rgb(87, 183, 221, 0.7)',
                        borderColor: 'rgb(87, 183, 221)',
                        borderWidth: 1,
                        radius: 0
                        },                        
                    ]
                    },
                    options: {
                        scales: {

                                xAxes: [{
                                    type: 'time',
                                    time: {
                                        minUnit: myunit,
                                    }, 
                                    distribution: 'linear',
                                    ticks: {
                                        fontStyle: "bold",
                                        min: mystarttime,
                                        max: myendtime,
                                            },
                                    scaleLabel: {
                                        display: false,                                                                  
                                            }
                                        }
                                ],
                                yAxes: [{
                                    ticks: {
                                        fontSize: 15,
                                        fontStyle: "bold",
                                            },
                                            scaleLabel: {
                                        display: false                                      
                                            }
                                        }]
                                },
                        title: {
                            text: "Humidity (%)",
                                }
                            } 
            });
        // End of graph 2

        //Graph 3 - light
        if (myChart_light) {
            myChart_light.destroy();
            }

        var ctx_lig = document.getElementById('ca_lig').getContext('2d'); 
        myChart_light = new Chart(ctx_lig, {
                type: 'line',
                data: {
                    labels: xs,
                    datasets: [
                        {                               
                        data: ys3,
                        fill: true,
                        backgroundColor: 'rgb(255, 190, 10, 0.7)',
                        borderColor: 'rgb(255, 190, 10)',
                        borderWidth: 1,
                        radius: 0
                        },                        
                    ]
                    },
                    options: {
                        scales: {
                                xAxes: [{
                                    type: 'time',
                                    time: {
                                        minUnit: myunit,
                                    }, 
                                    distribution: 'linear',
                                    ticks: {
                                        fontStyle: "bold",
                                        min: mystarttime,
                                        max: myendtime,
                                            },
                                    scaleLabel: {
                                        display: false,                                                                  
                                            }
                                        }
                                ],
                                yAxes: [{
                                    ticks: {
                                        fontSize: 15,
                                        fontStyle: "bold",
                                            },
                                            scaleLabel: {
                                        display: false                                      
                                            }
                                        }]
                                },
                        title: {
                            text: "Light (Lux)",
                                }
                            } 
            });
        // End of graph 3

        //Graph 4 - motion
        if (myChart_motion) {
            myChart_motion.destroy();
            }

        var ctx_mot = document.getElementById('ca_mot').getContext('2d'); 
        myChart_motion = new Chart(ctx_mot, {
                type: 'line',
                data: {
                    labels: xs,
                    datasets: [
                        {                              
                        data: ys4,
                        fill: true,
                        backgroundColor: 'rgb(138, 197, 57, 0.7)',
                        borderColor: 'rgb(138, 197, 57)',
                        borderWidth: 1,
                        radius: 0
                        },                        
                    ]
                    },
                    options: {
                        scales: {

                                xAxes: [{
                                    type: 'time',
                                    time: {
                                        minUnit: myunit,
                                    },
                                    distribution: 'linear',
                                    ticks: {
                                        fontStyle: "bold",
                                        min: mystarttime,
                                        max: myendtime,
                                            },
                                    scaleLabel: {
                                        display: false,                                                                  
                                            }
                                        }
                                ],
                                yAxes: [{
                                    ticks: {
                                        fontSize: 15,
                                        fontStyle: "bold",
                                            },
                                            scaleLabel: {
                                        display: false                                      
                                            }
                                        }]
                                },
                        title: {
                            text: "Motion counts",
                                }
                            } 
            });
        // End of graph 4

        //Graph 5 - sluice gate 1            
        if (myChart_gate1) {
            myChart_gate1.destroy();
            }

        var ctx_ga1 = document.getElementById('ca_ga1').getContext('2d');
        myChart_gate1 = new Chart(ctx_ga1, {
                type: 'line',
                data: {
                    labels: xs5,
                    datasets: [
                        {                                
                        data: ys5,
                        fill: true,
                        backgroundColor: 'rgb(224, 83, 222, 0.7)',
                        borderColor: 'rgb(224, 83, 222, 0.7)',
                        borderWidth: 1,
                        radius: 0
                        },                        
                    ]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                type: 'time',
                                time: {
                                    minUnit: myunit,
                                }, 
                                distribution: 'linear',
                                ticks: {
                                    fontStyle: "bold",
                                    min: mystarttime,
                                    max: myendtime,
                                        },
                                scaleLabel: {
                                    display: false,                                                                  
                                        }
                                    }
                            ],
                            yAxes: [{
                                ticks: {
                                    fontSize: 15,
                                    fontStyle: "bold", min:0, max:1400,
                                        },
                                        scaleLabel: {
                                    display: false                                      
                                        }
                                    }]
                            },
                        title: {
                            text: "Sluice gate 1 (mm raised)"
                                },
                            } 
            });
        // End of graph 5

        //Graph 6 - sluice gate 2            
        if (myChart_gate2) {
            myChart_gate2.destroy();
            }

        var ctx_ga2 = document.getElementById('ca_ga2').getContext('2d');
        myChart_gate2 = new Chart(ctx_ga2, {
                type: 'line',
                data: {
                    labels: xs6,
                    datasets: [
                        {                                
                        data: ys6,
                        fill: true,
                        backgroundColor: 'rgb(224, 83, 222, 0.7)',
                        borderColor: 'rgb(224, 83, 222, 0.7)',
                        borderWidth: 1,
                        radius: 0
                        },                        
                    ]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                type: 'time',
                                time: {
                                    minUnit: myunit,
                                }, 
                                distribution: 'linear',
                                ticks: {
                                    fontStyle: "bold",
                                    min: mystarttime,
                                    max: myendtime,
                                        },
                                scaleLabel: {
                                    display: false,                                                                  
                                        }
                                    }
                            ],
                            yAxes: [{
                                ticks: {
                                    fontSize: 15,
                                    fontStyle: "bold", min:0, max:1400,
                                        },
                                        scaleLabel: {
                                    display: false                                      
                                        }
                                    }]
                            },
                        title: {
                            text: "Sluice gate 2 (mm raised)"
                                },
                            } 
            });
        // End of graph 6

        }
        // End of selectTimescale

// closing of GoDoIt function
};

// functions
async function getData() {

    const response = await fetch(myurl) 
    const data = await response.json()
    var arr = [data, param1, param2, param3] 
    return arr           
}

async function getData_gate() {

const response = await fetch(myurl_gate) 
const data = await response.json()
var arr = [data, param1, param2, param3] 
return arr           
}
    
// DO NOT REMOVE the comment below, it stops Wordpress from escaping ampersands
//--></script>