        <!-- Using luxon instead of moment for datetime handling. Downsampling added when displaying large numbers of data points. Some global defaults set for charts. -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
       <script src="https://cdn.jsdelivr.net/npm/luxon@2.0.1/build/global/luxon.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0/dist/chartjs-adapter-luxon.min.js"></script>
        <!-- For luxon formatting see https://github.com/moment/luxon/blob/master/docs/formatting.md -->
        <script src="https://unpkg.com/js-datepicker"></script>
        <link rel="stylesheet" href="https://unpkg.com/js-datepicker/dist/datepicker.min.css">


        <style>

            #tit {
                 font-family: Arial, Helvetica, sans-serif;
                 font-size: 20px;
                 text-align: center;
                            }
             #sub1 {
                 font-family: Arial, Helvetica, sans-serif;
                 font-size: 18px;
                 text-align: center;
             }
             #sub2 {
                 clear: left;
                 font-family: Arial, Helvetica, sans-serif;
                 font-size: 18px;
                 text-align: center;
                 line-height: 60px;
             }
             #dpk1 {
                 margin: 10px;
                 font-family: Arial, Helvetica, sans-serif;
             }
             #dpk2 {
                 margin: 10px;
                 font-family: Arial, Helvetica, sans-serif;
             }
             
             .btn {
                 font-size: 18px;
                 font-family: Arial, Helvetica, sans-serif;
                 padding: 10px 16px;
                 margin: 5px;
                 border-radius: 4px;
                 background-color: #e7e7e7;
             }
             .lab {
                 font-family: Arial, Helvetica, sans-serif;
                 font-style: normal;
                 white-space: nowrap;
             }
 
             /* Style the active class, and buttons on mouse-over */
             .active, .btn:hover {
             background-color: #1a73e8;
             color: white;
             }
             #ts {
                 white-space: nowrap;
             }
             .box {
                 width: 230px;
                 height: 230px;
                 margin: 20px;
                 padding: 5px 10px;
                 font-family: Arial, Helvetica, sans-serif;
                 font-size: 17px;
                 color: white;
                 float: left;
             }
             .inner {
                 height: 230px; 
                 margin-top: -30px;
                 text-align:center;
                 display:flex;                
                 align-items: center;
                 justify-content: center;
                 font-size: 80px;
                 font-weight: bold;
                 color: white;               
             }
             .cwra {
                 width: 540px;
                 height: 270px;
                 margin: 20px;
                 float: left;
             }
             .cle {
                 clear: left;
             }
            #con {
                 max-width: 1280px;
                 margin: auto;
            }
            #wra1 {
                /* local */
                /* max-width: 1160px; */
                /* Wordpress */
                max-width: 1080px;
                margin: auto;
             }
             #btw {
                 max-width: 1160px;
                 margin: auto;
                 text-align:center;
             }
             #dtw {
                 max-width: 1160px;
                 margin: auto;
                 text-align:center;
             }
             #wra2 {
                max-width: 1160px;
                margin: auto;
             }
             #wra3 {
                max-width: 1160px;
                margin: auto;
             }
            #tem {
                background-color: #ff6d56;
             }
            #hum {
                background-color: #57b7dd;
             }
            #lig {
                background-color: #ffbe0a;
             }
            #mot {
                background-color: #8ac539;
             }
 
             #chart1 {
                 height: 100%;                          
             }
             #chart2 {
                 height: 100%;                          
             }
 
             @media only screen and (max-width: 1190px) {
                 #wra1 {
                 max-width: 580px;                
                 }
                 #wra2 {
                 max-width: 580px;                
                 }
                 #wra3 {
                 max-width: 580px;                
                 }
             }
             @media only screen and (max-width: 610px) {
                 #wra1 {
                 max-width: 290px;
                  }
                  #btw {
                 max-width: 300px;
                  }
                  #dtw {
                 width: 260px;
                  }                 
                  #wra2 {
                 max-width: 350px;
                  }
                  #wra3 {
                 max-width: 350px;
                  }
                  .cwra {
                      width: 350px;
                      height: 300px;
                      margin: auto;
                  }
                  
             }
         
        </style>

         <script>

        // Start an IIFE to use `await` at the top level
        (async function(){
        var global_data = await getData();

                var myChart1
                var myChart2
                var myChart3
                var myChart4
        
                const container = document.createElement('div')
                const title = document.createElement('h1')
                const subtitle1 = document.createElement('div')
                const subtitle2 = document.createElement('div')
                const buttonwrap = document.createElement('div')
                const button1 = document.createElement('button')
                const button2 = document.createElement('button')
                const button3 = document.createElement('button')
                const button4 = document.createElement('button')
                const datewrap = document.createElement('div')
                const datepick1 = document.createElement('input')
                const datepick2 = document.createElement('input')
                const label1 = document.createElement('label')
                const label2 = document.createElement('label')
                const nowtemp = document.createElement('div')
                const nowhumid = document.createElement('div')
                const nowlight = document.createElement('div')
                const nowmotion = document.createElement('div')
                const inner_nowtemp = document.createElement('div')
                const inner_nowhumid = document.createElement('div')
                const inner_nowlight = document.createElement('div')
                const inner_nowmotion = document.createElement('div')
                const wrap1 = document.createElement('div')
                const wrap2 = document.createElement('div')
                const wrap3 = document.createElement('div')
                const clear = document.createElement('p')
                const canv1 = document.createElement('canvas')
                const canv2 = document.createElement('canvas')
                const canv3 = document.createElement('canvas')
                const canv4 = document.createElement('canvas')

                const canvwrap1 = document.createElement('div')
                const canvwrap2 = document.createElement('div')
                const canvwrap3 = document.createElement('div')
                const canvwrap4 = document.createElement('div')

                
                container.id = "con"
                title.id = "tit"
                subtitle1.id = "sub1"
                subtitle2.id = "sub2"
                buttonwrap.id = "btw"
                datewrap.id = "dtw"
                datepick1.type = "text"
                datepick1.id = "dpk1"
                datepick2.type = "text"
                datepick2.id = "dpk2"
                label1.for = "dpk1"
                label2.for = "dpk2"
                nowtemp.id = "tem"
                nowhumid.id = "hum"
                nowlight.id = "lig"
                nowmotion.id = "mot"
                wrap1.id = "wra1"
                wrap2.id = "wra2"
                wrap3.id = "wra3"
                canv1.id = "chart1"
                canv2.id = "chart2"
                canv3.id = "chart3"
                canv4.id = "chart4"

                nowtemp.className = "box"
                nowhumid.className = "box"
                nowlight.className = "box"
                nowmotion.className = "box"
                inner_nowtemp.className = "inner"
                inner_nowhumid.className = "inner"
                inner_nowlight.className = "inner"
                inner_nowmotion.className = "inner"
                clear.className = "cle"
                button1.className = "btn"
                button2.className = "btn active"
                button3.className = "btn"
                button4.className = "btn"
                label1.className = "lab"
                label2.className = "lab"
                canvwrap1.className = "cwra"
                canvwrap2.className = "cwra"
                canvwrap3.className = "cwra"
                canvwrap4.className = "cwra"

                title.innerHTML = "Turbine House"
                //subtitle1.innerHTML = `Current conditions: <span id="ts">${luxon.DateTime.fromISO(global_data[0].received_at).toFormat('ff')} </span>`
                //temp adjustment until timezone issue resolved
                subtitle1.innerHTML = `Current conditions: <span id="ts">${luxon.DateTime.fromISO(global_data[0].received_at, { setZone: true }).toFormat('ff')} </span>`
                subtitle2.innerHTML = "<span>Conditions over selected period</span>"
                button1.innerHTML = "Last day"
                button1.onclick = function(){picker1.setDate(yesterday, true); picker2.setDate(today, true); selectTimescale(yesterday, today)}
                button2.innerHTML = "Last week"
                button2.onclick = function(){picker1.setDate(lastweek, true); picker2.setDate(today, true); selectTimescale(lastweek, today)}
                button3.innerHTML = "Last month"
                button3.onclick = function(){picker1.setDate(lastmonth, true); picker2.setDate(today, true); selectTimescale(lastmonth, today)}
                button4.innerHTML = "Last year"
                button4.onclick = function(){picker1.setDate(lastyear, true); picker2.setDate(today, true); selectTimescale(lastyear, today)}

                nowtemp.innerHTML = "Temperature (&deg;C)"
                nowhumid.innerHTML = "Humidity (&percnt;)"
                nowlight.innerHTML = "Light (Lux)" 
                nowmotion.innerHTML = "Motion counts"
                label1.innerHTML = "Start date"
                label2.innerHTML = "End date"
                inner_nowtemp.textContent = global_data[0].temperature
                inner_nowhumid.textContent = global_data[0].humidity
                inner_nowlight.textContent = global_data[0].light
                inner_nowmotion.textContent = global_data[0].motion 

                nowtemp.append(inner_nowtemp)
                nowhumid.append(inner_nowhumid)
                nowlight.append(inner_nowlight)
                nowmotion.append(inner_nowmotion)

                wrap1.append(nowtemp, nowhumid, nowlight, nowmotion, clear)
                container.append(title)
                container.append(subtitle1)
                container.append(wrap1)
                container.append(subtitle2)
                buttonwrap.append(button1, button2, button3, button4, clear)
                container.append(buttonwrap)
                datewrap.append(label1, datepick1, label2, datepick2, clear)
                container.append(datewrap)
                canvwrap1.append(canv1)
                canvwrap2.append(canv2)                
                canvwrap3.append(canv3)
                canvwrap4.append(canv4)
                wrap2.append(canvwrap1, canvwrap2, clear)
                wrap3.append(canvwrap3, canvwrap4)

                container.append(wrap2)
                container.append(wrap3)
                
                //local
                //document.body.append(container)
                //Wordpress
                var target = document.getElementsByClassName("entry-content");
                target[0].append(container)
            
            //filter by date
            let today = new Date()
            let yesterday = new Date()
            let daybefore = new Date()
            let lastweek = new Date()
            let lastmonth = new Date()
            let lastyear = new Date()
            yesterday.setDate(today.getDate() - 1)
            daybefore.setDate(today.getDate() - 2)
            lastweek.setDate(today.getDate() - 7)
            lastmonth.setDate(today.getDate() - 31)
            lastyear.setDate(today.getDate() - 365)

            var picked = false

            const picker1 = datepicker('#dpk1', { id: 1, dateSelected: lastweek, onSelect: instance => {picked = true; selectTimescale(picker1.getRange().start, picker1.getRange().end ) }})
            const picker2 = datepicker('#dpk2', { id: 1, dateSelected: today, onSelect: instance => {picked = true; selectTimescale(picker2.getRange().start, picker2.getRange().end ) }})


        selectTimescale(lastweek, today)

        function selectTimescale(mystart, myend) {
            var selection = global_data.filter(function(item){
                        return new Date(item.received_at) >= mystart && item.device_id == 'rdghydro-ers001'
                    })
                    var mystarttime = mystart
                    var myendtime = myend
                    var mylength = myendtime - mystarttime
                    if (mylength >= 172800000){
                        myunit = 'day'
                    }else{
                        myunit = 'hour'
                    }

                    // Downsample if greater than 10512 data points (approx 2.5 months)
                    // No of points will vary between 5256 and 10512
                    if (selection.length > 10512){
                        var step = Math.ceil(selection.length/10512)
                        var reduced = []
                        for (i = 0; i < selection.length; i++) {
                            if(i % step === 0){
                                reduced.push(selection[i])
                            }
                        }
                        selection = reduced
                        }

                    const xs = []
                    const ys1 = []
                    const ys2 = []
                    const ys3 = []
                    const ys4 = []
                    for(item of selection) {                

                        //convert the timestamp to milliseconds (faster)                
                        const mydate1 = new Date(item.received_at)
                        //const mydate = mydate1.getTime()
                        const mydate = (mydate1.getTime() - 3600000) //temp adjustment until timezone issue resolved
                        xs.push(mydate);
                        const mytemp = item.temperature;
                        ys1.push(mytemp);
                        const myhum = item.humidity;
                        ys2.push(myhum);
                        const mylig = item.light;
                        ys3.push(mylig);
                        const mymot = item.motion;
                        ys4.push(mymot);
                    }

                    // Add active class to the current button on click
                    var btns = document.getElementsByClassName("btn");
                    for (var i = 0; i < btns.length; i++) {
                    btns[i].addEventListener("click", function() {
                        var current = document.getElementsByClassName("active");
                        if (typeof current[0] !== 'undefined'){
                        current[0].className = current[0].className.replace(" active", "");
                        }
                        this.className += " active";
                        });
                        }
                     if (picked == true) {
                        for (var i = 0; i < btns.length; i++) {
                            btns[i].classList.remove("active")
                        } 
                        picked = false
                    }

                //Set global defaults for charts
                //More settings can be global if we use Chartjs v3
                Chart.defaults.global.tooltips.callbacks.title = function(t, d) {
                                        return luxon.DateTime.fromMillis(d.labels[t[0].index]).toFormat('ff');
                                                }
                //Chart.defaults.global.animation.duration = 0
                Chart.defaults.global.maintainAspectRatio = false
                Chart.defaults.global.title.display = true
                Chart.defaults.global.title.fontSize = 20
                Chart.defaults.global.title.fontStyle = 'bold'
                Chart.defaults.global.legend.display = false


                //Graph 1 - temperature            
                if (myChart1) {
                    myChart1.destroy();
                    }
        
                var ctx1 = document.getElementById('chart1').getContext('2d');
                myChart1 = new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: xs,
                            datasets: [
                                {                                
                                data: ys1,
                                fill: true,
                                backgroundColor: 'rgb(255, 109, 86, 0.7)',
                                borderColor: 'rgb(255, 109, 86, 0.7)',
                                borderWidth: 1,
                                radius: 0
                                },                        
                            ]
                            },
                            options: {
                                scales: {
                                    xAxes: [{
                                        type: 'time',
                                        time: {
                                            minUnit: myunit,
                                        }, 
                                        distribution: 'linear',
                                        ticks: {
                                            fontStyle: "bold",
                                            min: mystarttime,
                                            max: myendtime,
                                                },
                                        scaleLabel: {
                                            display: false,                                                                  
                                                }
                                            }
                                    ],
                                    yAxes: [{
                                        ticks: {
                                            fontSize: 15,
                                            fontStyle: "bold",
                                                },
                                                scaleLabel: {
                                            display: false                                      
                                                }
                                            }]
                                    },
                                title: {
                                    text: "Temperature (Â°C)"
                                        },
                                    } 
                    });
                // End of graph 1

                //Graph 2 - humidity
                if (myChart2) {
                    myChart2.destroy();
                    }

                var ctx2 = document.getElementById('chart2').getContext('2d');
                myChart2 = new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: xs,
                            datasets: [
                                {
                                
                                data: ys2,
                                fill: true,
                                backgroundColor: 'rgb(87, 183, 221, 0.7)',
                                borderColor: 'rgb(87, 183, 221)',
                                borderWidth: 1,
                                radius: 0
                                },                        
                            ]
                            },
                            options: {
                                scales: {

                                        xAxes: [{
                                            type: 'time',
                                            time: {
                                                minUnit: myunit,
                                            }, 
                                            distribution: 'linear',
                                            ticks: {
                                                fontStyle: "bold",
                                                min: mystarttime,
                                                max: myendtime,
                                                    },
                                            scaleLabel: {
                                                display: false,                                                                  
                                                    }
                                                }
                                        ],
                                        yAxes: [{
                                            ticks: {
                                                fontSize: 15,
                                                fontStyle: "bold",
                                                    },
                                                    scaleLabel: {
                                                display: false                                      
                                                    }
                                                }]
                                        },
                                title: {
                                    text: "Humidity (%)",
                                        }
                                    } 
                    });
                // End of graph 2

                //Graph 3 - light
                if (myChart3) {
                    myChart3.destroy();
                    }

                var ctx3 = document.getElementById('chart3').getContext('2d'); 
                myChart3 = new Chart(ctx3, {
                        type: 'line',
                        data: {
                            labels: xs,
                            datasets: [
                                {                               
                                data: ys3,
                                fill: true,
                                backgroundColor: 'rgb(255, 190, 10, 0.7)',
                                borderColor: 'rgb(255, 190, 10)',
                                borderWidth: 1,
                                radius: 0
                                },                        
                            ]
                            },
                            options: {
                                scales: {
                                        xAxes: [{
                                            type: 'time',
                                            time: {
                                                minUnit: myunit,
                                            }, 
                                            distribution: 'linear',
                                            ticks: {
                                                fontStyle: "bold",
                                                min: mystarttime,
                                                max: myendtime,
                                                    },
                                            scaleLabel: {
                                                display: false,                                                                  
                                                    }
                                                }
                                        ],
                                        yAxes: [{
                                            ticks: {
                                                fontSize: 15,
                                                fontStyle: "bold",
                                                    },
                                                    scaleLabel: {
                                                display: false                                      
                                                    }
                                                }]
                                        },
                                title: {
                                    text: "Light (Lux)",
                                        }
                                    } 
                    });
                // End of graph 3

                //Graph 4 - motion
                if (myChart4) {
                    myChart4.destroy();
                    }

                var ctx4 = document.getElementById('chart4').getContext('2d'); 
                myChart4 = new Chart(ctx4, {
                        type: 'line',
                        data: {
                            labels: xs,
                            datasets: [
                                {                              
                                data: ys4,
                                fill: true,
                                backgroundColor: 'rgb(138, 197, 57, 0.7)',
                                borderColor: 'rgb(138, 197, 57)',
                                borderWidth: 1,
                                radius: 0
                                },                        
                            ]
                            },
                            options: {
                                scales: {

                                        xAxes: [{
                                            type: 'time',
                                            time: {
                                                minUnit: myunit,
                                            },
                                            distribution: 'linear',
                                            ticks: {
                                                fontStyle: "bold",
                                                min: mystarttime,
                                                max: myendtime,
                                                    },
                                            scaleLabel: {
                                                display: false,                                                                  
                                                    }
                                                }
                                        ],
                                        yAxes: [{
                                            ticks: {
                                                fontSize: 15,
                                                fontStyle: "bold",
                                                    },
                                                    scaleLabel: {
                                                display: false                                      
                                                    }
                                                }]
                                        },
                                title: {
                                    text: "Motion counts",
                                        }
                                    } 
                    });
                // End of graph 4

                }
                // End of selectTimescale

        //closing of IIFE function
        })();


// functions
        async function getData() {
            //local
            //const response = await fetch('/hook') 
            //Wordpress
            const response = await fetch('https://thingitude-apps.com:9445/api/ttn/all') 
            const data = await response.json() 
            return data           
        }
            
        </script>


