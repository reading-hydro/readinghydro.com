<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/luxon@2.0.1/build/global/luxon.min.js"></script>
<style>

   .tt {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
                   }
    .ttsmall {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 20px;
        text-align: center;
        margin-bottom: 30px;
                   }
    .notes {
        text-align: inherit;
        color: #E5004D;
     }
    .sub_data {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 18px;
        text-align: center;
        margin-bottom: 10px;
    }
    .box_data {
        width: 420px;
        height: 70px;
        margin: 5px 25px 5px 25px;
        padding: 5px 20px 5px 10px;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 22px;
        color: white;
        float: left;
    }
    .inner {
        height: 70px; 
        margin-top: -20px;
        text-align: right;
        display:flex;                
        align-items: center;
        justify-content: flex-end;
        font-weight: bold;
        color: white;             
    }
    .fontbig {
        font-size: 38px;            
    }
    .fontsmall {
        font-size: 25px;            
    }
    .cle {
        clear: left;
    }
    .ts {
        white-space: nowrap;
    }
    #wra_PO {
        max-width: 1000px;
        margin: auto;
    }
    #wra_TOT {
        max-width: 500px;
        margin: auto;
    }
    #wra_T1 {
        max-width: 500px;
        padding-bottom: 40px;
        float: left;
    }
    #wra_T2 {
        max-width: 500px;
        padding-bottom: 40px;
        float: left;
    }
    #wra_TH_RC {
        max-width: 1000px;
        margin: auto;
    }
    #wra_TH {
        max-width: 500px;
        padding-bottom: 40px;
        float: left;
    }
    #wra_RC {
        max-width: 500px;
        padding-bottom: 40px;
        float: left;
    }
   #con {
        max-width: 1280px;
        margin: auto;
        /* override WP theme */
        line-height: 1.0;
   }
   #tot {
        background-color: #AA10FF;
        margin-bottom: 40px;
    }
   #pow1 {
        background-color: #7A65CF;
    }
    #srpm1 {
        background-color: #7A65CF;
    }
    #drpm1 {
        background-color: #7A65CF;
    }
    #opho1 {
        background-color: #7A65CF;
    }
    #ener1 {
        background-color: #7A65CF;
    }
    #pow2 {
        background-color: #DE2F55;
    }
    #srpm2 {
        background-color: #DE2F55;
    }
    #drpm2 {
        background-color: #DE2F55;
    }
    #opho2 {
        background-color: #DE2F55;
    }
    #ener2 {
        background-color: #DE2F55;
    }
   #up {
       background-color: #418AD9;
    }
   #dow {
       background-color: #418AD9;
    }
   #he {
       background-color: #418AD9;
    }
   #ahol {
       background-color: #418AD9;
    }
    #hol {
        background-color: #418AD9;
    }
    #flo1 {
        background-color: #37A19D;
    }
    #flo2 {
        background-color: #37A19D;
    }
    #EAflo {
        background-color: #3ca650;
    }
   #tem {
       background-color: #ED6651;
    }
   #hum {
       background-color: #167CAC;
    }

    @media only screen and (max-width: 1100px) {
        #wra_PO, #wra_TOT, #wra_TH_RC {
        max-width: 580px;              
        }
        #wra_T1, #wra_T2, #wra_TH, #wra_RC {
        max-width: 580px;
        float: none;
        }
        .box_data {
            float: none;
            margin: 5px auto;
        }                
    }

    @media only screen and (max-width: 610px) {
        #wra_PO {
        max-width: 350px;
         }
         #wra_TOT {
        max-width: 350px;
         }
         #wra_TH_RC {
        max-width: 350px;
         }
         #wra_T1, #wra_T2, #wra_TH, #wra_RC {
        padding-bottom: 20px;
        }
         .box_data {
            width: 320px;
        }
        .fontbig {
            font-size: 30px;
        }
        .fontsmall {
            font-size: 20px;
        }
        .tt {
            font-size: 18px;
        }
        .ttsmall {
            font-size: 14px;
        }
        .sub_data {
            font-size: 15px;
        }
    }

    @media only screen and (max-width: 360px) {
        /* this is for really tiny phones */
        .box_data {
        width: 270px;
        float: none;  
        margin: 5px auto;
        }
    }

</style>        

 <script>

// Start an IIFE to use `await` at the top level
(async function(){
var global_data1 = await getData1();
var global_data2 = await getData2();
var global_data3 = await getDataMeter();
var global_data_meter = global_data3.filter(function(item){
                return item.meter == '70150046'
            })       

var setdata = await getData3()
var HOL = setdata.level
//##############################
// Comment out this line if EA API giving errors
var EA_data = await getData4()
//##############################

// This is the LIVE DATA summary page
        const container = document.createElement('div')                
        const title_TH = document.createElement('div')
        const title_RC = document.createElement('div')
        const title_PO = document.createElement('div')
        const under_title_TH = document.createElement('div')
        const under_title_RC = document.createElement('div')
        const under_title_PO = document.createElement('div')
        const notes = document.createElement('p')

        const subtitle_TH = document.createElement('div')
        const subtitle_RC = document.createElement('div')
        const subtitle_T1 = document.createElement('div')
        const subtitle_T2 = document.createElement('div')
        const subtitle_TOT = document.createElement('div')

        const now_total = document.createElement('div')

        const nowPower_G1 = document.createElement('div')
        const nowScrewRPM_G1 = document.createElement('div')
        const nowDriveRPM_G1 = document.createElement('div')
        const nowOpHours_G1 = document.createElement('div')
        const nowEnergy_G1 = document.createElement('div')

        const nowPower_G2 = document.createElement('div')
        const nowScrewRPM_G2 = document.createElement('div')
        const nowDriveRPM_G2 = document.createElement('div')
        const nowOpHours_G2 = document.createElement('div')
        const nowEnergy_G2 = document.createElement('div')
        
        const now_upst = document.createElement('div')
        const now_down = document.createElement('div')
        const now_head = document.createElement('div')
        const now_aboveHOL = document.createElement('div')
        const now_HOL = document.createElement('div')
        const now_flow1 = document.createElement('div')
        const now_flow2 = document.createElement('div')
        const now_EAflow = document.createElement('div')

        const nowtemp = document.createElement('div')
        const nowhumid = document.createElement('div')

        const inner_now_total = document.createElement('div')

        const inner_nowPower_G1 = document.createElement('div')
        const inner_nowScrewRPM_G1 = document.createElement('div')
        const inner_nowDriveRPM_G1 = document.createElement('div')
        const inner_nowOpHours_G1 = document.createElement('div')
        const inner_nowEnergy_G1 = document.createElement('div')

        const inner_nowPower_G2 = document.createElement('div')
        const inner_nowScrewRPM_G2 = document.createElement('div')
        const inner_nowDriveRPM_G2 = document.createElement('div')
        const inner_nowOpHours_G2 = document.createElement('div')
        const inner_nowEnergy_G2 = document.createElement('div')

        const inner_now_upst = document.createElement('div')
        const inner_now_down = document.createElement('div')
        const inner_now_head = document.createElement('div')
        const inner_now_aboveHOL = document.createElement('div')
        const inner_now_HOL = document.createElement('div')
        const inner_now_flow1 = document.createElement('div')
        const inner_now_flow2 = document.createElement('div')
        const inner_now_EAflow = document.createElement('div')

        const inner_nowtemp = document.createElement('div')
        const inner_nowhumid = document.createElement('div')
        
        const wrap_PO = document.createElement('div')
        const wrap_TOT = document.createElement('div')  
        const wrap_T1 = document.createElement('div')
        const wrap_T2 = document.createElement('div')
        const wrap_TH_RC = document.createElement('div')
        const wrap_TH = document.createElement('div')
        const wrap_RC = document.createElement('div')

        const clear = document.createElement('p')

        
        container.id = "con"

        now_total.id = "tot"

        nowPower_G1.id = "pow1"
        nowScrewRPM_G1.id = "srpm1"
        nowDriveRPM_G1.id = "drpm1"
        nowOpHours_G1.id = "opho1"
        nowEnergy_G1.id = "ener1"

        nowPower_G2.id = "pow2"
        nowScrewRPM_G2.id = "srpm2"
        nowDriveRPM_G2.id = "drpm2"
        nowOpHours_G2.id = "opho2"
        nowEnergy_G2.id = "ener2"
        
        now_upst.id = "up"
        now_down.id = "dow"
        now_head.id = "he"
        now_aboveHOL.id = "ahol"
        now_HOL.id = "hol"
        now_flow1.id = "flo1"
        now_flow2.id = "flo2"
        now_EAflow.id = "EAflo"

        nowtemp.id = "tem"
        nowhumid.id = "hum"

        wrap_PO.id = "wra_PO"
        wrap_TOT.id = "wra_TOT"
        wrap_T1.id = "wra_T1"
        wrap_T2.id = "wra_T2"
        wrap_TH_RC.id = "wra_TH_RC"
        wrap_TH.id = "wra_TH"
        wrap_RC.id = "wra_RC"

        title_TH.className = "tt"
        title_RC.className = "tt"
        title_PO.className = "tt"
        under_title_TH.className = "ttsmall"
        under_title_RC.className = "ttsmall"
        under_title_PO.className = "ttsmall"
        notes.className = "notes"
        subtitle_TOT.className = "sub_data"
        subtitle_TH.className = "sub_data"
        subtitle_RC.className = "sub_data"
        subtitle_T1.className = "sub_data"
        subtitle_T2.className = "sub_data"

        now_total.className = "box_data"

        nowPower_G1.className = "box_data"
        nowScrewRPM_G1.className = "box_data"
        nowDriveRPM_G1.className = "box_data"
        nowOpHours_G1.className = "box_data"
        nowEnergy_G1.className = "box_data"

        nowPower_G2.className = "box_data"
        nowScrewRPM_G2.className = "box_data"
        nowDriveRPM_G2.className = "box_data"
        nowOpHours_G2.className = "box_data"
        nowEnergy_G2.className = "box_data"
        
        now_upst.className = "box_data"
        now_down.className = "box_data"
        now_head.className = "box_data"
        now_aboveHOL.className = "box_data"
        now_HOL.className = "box_data"
        now_flow1.className = "box_data"
        now_flow2.className = "box_data"
        now_EAflow.className = "box_data"

        nowtemp.className = "box_data"
        nowhumid.className = "box_data"

        inner_now_total.className ="inner fontbig"

        inner_nowPower_G1.className = "inner fontbig"
        inner_nowScrewRPM_G1.className = "inner fontbig"
        inner_nowDriveRPM_G1.className = "inner fontbig"
        inner_nowOpHours_G1.className = "inner fontbig"
        inner_nowEnergy_G1.className = "inner fontbig"

        inner_nowPower_G2.className = "inner fontbig"
        inner_nowScrewRPM_G2.className = "inner fontbig"
        inner_nowDriveRPM_G2.className = "inner fontbig"
        inner_nowOpHours_G2.className = "inner fontbig"
        inner_nowEnergy_G2.className = "inner fontbig"

        inner_now_upst.className = "inner fontbig"
        inner_now_down.className = "inner fontbig"
        inner_now_head.className = "inner fontbig"
        inner_now_aboveHOL.className = "inner fontbig"
        inner_now_HOL.className = "inner fontbig"
        inner_now_flow1.className = "inner fontbig"
        inner_now_flow2.className = "inner fontbig"
        inner_now_EAflow.className = "inner fontbig"

        inner_nowtemp.className = "inner fontbig"
        inner_nowhumid.className = "inner fontbig"

        clear.className = "cle"

        notes.innerHTML = "See data history pages for explanatory notes"

        title_PO.innerHTML = '<a href="/power-output-data/">Electricity generation</a>'
        under_title_PO.innerHTML = '<a href="/power-output-data/">click for data history</a>'
        subtitle_T1.innerHTML = `Turbine 1 (Tony): <span class="ts">${luxon.DateTime.fromISO(global_data2[0].received_at).toFormat('ff')} </span><br />Current performance of turbine and generator`
        subtitle_TOT.innerHTML = 'Total electricity exported to date (both turbines)'

        now_total.innerHTML = 'Total export (MWh)'

        nowPower_G1.innerHTML = 'Power generation (kW)'
        nowScrewRPM_G1.innerHTML = 'Screw speed (RPM)'
        nowDriveRPM_G1.innerHTML = 'Drive speed (RPM)'
        nowOpHours_G1.innerHTML = 'Total operating (hours)'
        nowEnergy_G1.innerHTML = 'Total generation (MWh)'

        inner_now_total.textContent = (global_data_meter[0].export/1000).toFixed(1)

        inner_nowPower_G1.textContent = Math.min(global_data2[0].gen1_power_kw, 23)
        if (inner_nowPower_G1.textContent < 0){
            inner_nowPower_G1.textContent = 0
        }
        inner_nowScrewRPM_G1.textContent = global_data2[0].gen1_screw_rpm
        inner_nowDriveRPM_G1.textContent = global_data2[0].gen1_drive_rpm
        inner_nowOpHours_G1.textContent = global_data2[0].gen1_operating_hours
        inner_nowEnergy_G1.textContent = global_data2[0].gen1_energy_mwh

        now_total.append(inner_now_total)

        nowPower_G1.append(inner_nowPower_G1)
        nowScrewRPM_G1.append(inner_nowScrewRPM_G1)
        nowDriveRPM_G1.append(inner_nowDriveRPM_G1)
        nowOpHours_G1.append(inner_nowOpHours_G1)
        nowEnergy_G1.append(inner_nowEnergy_G1)

        wrap_PO.append(title_PO, under_title_PO)
        wrap_TOT.append(now_total)
        wrap_PO.append(subtitle_TOT, wrap_TOT)
        wrap_T1.append(subtitle_T1)
        wrap_T1.append(nowPower_G1, nowScrewRPM_G1, nowDriveRPM_G1, nowOpHours_G1, nowEnergy_G1, clear)
        wrap_PO.append(wrap_T1)

        subtitle_T2.innerHTML = `Turbine 2 (Sophie): <span class="ts">${luxon.DateTime.fromISO(global_data2[0].received_at).toFormat('ff')} </span><br />Current performance of turbine and generator`

        nowPower_G2.innerHTML = 'Power generation (kW)'
        nowScrewRPM_G2.innerHTML = 'Screw speed (RPM)'
        nowDriveRPM_G2.innerHTML = 'Drive speed (RPM)'
        nowOpHours_G2.innerHTML = 'Total operating (hours)'
        nowEnergy_G2.innerHTML = 'Total generation (MWh)'

        inner_nowPower_G2.textContent = Math.min(global_data2[0].gen2_power_kw, 23)
        if (inner_nowPower_G2.textContent < 0){
            inner_nowPower_G2.textContent = 0
        }
        inner_nowScrewRPM_G2.textContent = global_data2[0].gen2_screw_rpm
        inner_nowDriveRPM_G2.textContent = global_data2[0].gen2_drive_rpm
        inner_nowOpHours_G2.textContent = global_data2[0].gen2_operating_hours
        inner_nowEnergy_G2.textContent = global_data2[0].gen2_energy_mwh

        nowPower_G2.append(inner_nowPower_G2)
        nowScrewRPM_G2.append(inner_nowScrewRPM_G2)
        nowDriveRPM_G2.append(inner_nowDriveRPM_G2)
        nowOpHours_G2.append(inner_nowOpHours_G2)
        nowEnergy_G2.append(inner_nowEnergy_G2)

        wrap_T2.append(subtitle_T2)
        wrap_T2.append(nowPower_G2, nowScrewRPM_G2, nowDriveRPM_G2, nowOpHours_G2, nowEnergy_G2, clear)
        wrap_PO.append(wrap_T2)

        container.append(notes)
        container.append(wrap_PO)

        title_RC.innerHTML = '<a href="/water-level-data/">River conditions</a>'
        under_title_RC.innerHTML = '<a href="/water-level-data/">click for data history</a>'
        subtitle_RC.innerHTML = `Current conditions: <span class="ts">${luxon.DateTime.fromISO(global_data2[0].received_at).toFormat('ff')} </span>`

        now_upst.innerHTML = "Upstream (metres AOD)"
        now_down.innerHTML = "Downstream (metres AOD)"
        now_head.innerHTML = "Head (metres)" 
        now_aboveHOL.innerHTML = "Above set level (metres)"
        now_HOL.innerHTML = "Present set level (metres)"
        now_flow1.innerHTML = "Water flow turbine 1 (m<sup>3</sup>/s)"
        now_flow2.innerHTML = "Water flow turbine 2 (m<sup>3</sup>/s)"
        now_EAflow.innerHTML = "Flow at Reading Bridge (m<sup>3</sup>/s)"
        inner_now_upst.textContent = global_data2[0].upstream.toFixed(3)
        inner_now_down.textContent = global_data2[0].downstream.toFixed(3)
        inner_now_head.textContent = (global_data2[0].upstream - global_data2[0].downstream).toFixed(3)
        inner_now_aboveHOL.textContent = (global_data2[0].upstream - HOL).toFixed(3)
        inner_now_HOL.textContent = HOL.toFixed(3)
        inner_now_flow1.textContent = (global_data2[0].gen1_flow_ls/1000).toFixed(2)
        inner_now_flow2.textContent = (global_data2[0].gen2_flow_ls/1000).toFixed(2)
        if (typeof EA_data !== 'undefined'){
            inner_now_EAflow.textContent = (EA_data.flow).toFixed(2)
            }

        now_upst.append(inner_now_upst)
        now_down.append(inner_now_down)
        now_head.append(inner_now_head)
        now_aboveHOL.append(inner_now_aboveHOL)
        now_HOL.append(inner_now_HOL)
        now_flow1.append(inner_now_flow1)
        now_flow2.append(inner_now_flow2)
        now_EAflow.append(inner_now_EAflow)

        wrap_RC.append(title_RC, under_title_RC)
        wrap_RC.append(subtitle_RC)
        wrap_RC.append(now_upst, now_down, now_head, now_aboveHOL, now_HOL, now_flow1, now_flow2, now_EAflow, clear)
        wrap_TH_RC.append(wrap_RC)

        title_TH.innerHTML = '<a href="/turbine-house-data/">Turbine house</a>'
        under_title_TH.innerHTML = '<a href="/turbine-house-data/">click for data history</a>'
        //Filter out other devices
        var selection1 = global_data1.filter(function(item){
                return item.device_id == 'rdghydro-ers001'
            })

        subtitle_TH.innerHTML = `Current conditions: <span class="ts">${luxon.DateTime.fromISO(selection1[0].received_at).toFormat('ff')} </span>`

        nowtemp.innerHTML = "Temperature (&deg;C)"
        nowhumid.innerHTML = "Relative humidity (&percnt;)"

        inner_nowtemp.textContent = selection1[0].temperature
        inner_nowhumid.textContent = selection1[0].humidity

        nowtemp.append(inner_nowtemp)
        nowhumid.append(inner_nowhumid)
        
        wrap_TH.append(title_TH, under_title_TH)
        wrap_TH.append(subtitle_TH)
        wrap_TH.append(nowtemp, nowhumid, clear)
        wrap_TH_RC.append(wrap_TH)
        container.append(wrap_TH_RC)
        
        //local
        //document.body.append(container)
        //Wordpress
        var target = document.getElementsByClassName("entry-header");
        target[0].append(container)

//closing of IIFE function
})();


// functions
async function getData1() {
    const response = await fetch('https://readinghydro.org/api/ttn/today') 
    const data = await response.json() 
    return data           
}

async function getData2() {
    const response = await fetch('https://readinghydro.org/api/plc/today') 
    const data = await response.json() 
    return data           
}

async function getDataMeter() {
    const response = await fetch('https://readinghydro.org/api/meter/current') 
    const data = await response.json() 
    return data           
}

async function getData3() {
    const response = await fetch('https://readinghydro.org/api/setlevel/current') 
    const data = await response.json()
    return data           
    }

async function getData4() {
    const response = await fetch('https://readinghydro.org/api/eadata/current') 
    const data = await response.json()
    return data           
    }

</script>
